
def smart_substitution_advice(formula):
    suggestions = []

    if formula.get("精製細砂", 0) > 15:
        suggestions.append(
            "🔍 問題：精製細砂比例偏高（>15%）\n"
            "📌 原因：砂糖比例過高容易導致甜味壓過其他風味（如乳香、起司），且在烘焙時上色過快、升糖指數高，降低健康形象。\n"
            "✅ 建議：將比例降至約12%，可保留甜感並搭配赤藻糖醇補足，降低GI並保有甜味層次。"
        )

    if formula.get("赤藻糖醇", 0) > 6:
        suggestions.append(
            "🔍 問題：赤藻糖醇使用量偏高（>6%）\n"
            "📌 原因：過量可能導致冷涼感明顯、澀味增加，並可能在烘焙表面結晶產生顆粒感。\n"
            "✅ 建議：赤藻糖醇建議控制在6%以下，搭配砂糖可穩定甜感口感與烘焙穩定性。"
        )

    if formula.get("大豆蛋白", 0) + formula.get("乳清蛋白", 0) > 10:
        suggestions.append(
            "🔍 問題：蛋白粉總比例偏高（大豆+乳清 >10%）\n"
            "📌 原因：粉狀蛋白過多可能造成脆餅口感乾硬、密實、難以蓬發，影響脆度與適口性。\n"
            "✅ 建議：總粉體蛋白建議控制在8～10%以內，並搭配液蛋提升口感與結構穩定性。"
        )

    liquid_total = formula.get("冷藏未殺菌液蛋白", 0) + formula.get("冷藏未殺菌液蛋黃", 0) + formula.get("自來水", 0)
    if liquid_total < 35:
        suggestions.append(
            f"🔍 問題：液體總比例偏低（目前為 {liquid_total:.1f}%）\n"
            "📌 原因：液體不足會導致烘焙成品乾硬、難以蓬鬆，且易造成成品表面龜裂。\n"
            "✅ 建議：液體比例建議維持在40～50%，可透過增加液蛋或水來改善濕潤度與蓬鬆性。"
        )

    if formula.get("三合力9285", 0) < 0.2:
        suggestions.append(
            "🔍 問題：三合力香料比例偏低（<0.2%）\n"
            "📌 原因：香氣強度不足可能導致產品缺乏特色嗅覺記憶點，起司風味表現不明顯。\n"
            "✅ 建議：調升至0.2%為標準建議值，有助於提升產品辨識度與起司主題表現。"
        )

    if formula.get("沙拉油", 0) < 3:
        suggestions.append(
            "🔍 問題：沙拉油比例偏低（<3%）\n"
            "📌 原因：油脂不足可能造成口感過乾、脆化不完全、香氣層次不飽滿。\n"
            "✅ 建議：建議維持3～5%油脂比例作為酥脆潤口基礎，搭配乳酪粉可提升整體風味厚度。"
        )

    if not suggestions:
        return "✅ 目前配方整體結構穩定，營養比例平衡，無需大幅調整。"

    return "\n\n".join(suggestions)
