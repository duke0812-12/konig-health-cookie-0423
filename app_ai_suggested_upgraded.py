
import streamlit as st
import pandas as pd

ingredient_db = {
    "冷藏未殺菌液蛋白": {"熱量": 52, "蛋白質": 10.2, "脂肪": 0.1, "碳水": 0.8, "糖": 0.0, "鈉": 400},
    "冷藏未殺菌液蛋黃": {"熱量": 322, "蛋白質": 15.8, "脂肪": 26.5, "碳水": 3.6, "糖": 0.0, "鈉": 120},
    "大豆蛋白": {"熱量": 400, "蛋白質": 90.0, "脂肪": 1.2, "碳水": 1.5, "糖": 0.0, "鈉": 750},
    "乳清蛋白": {"熱量": 392, "蛋白質": 80.0, "脂肪": 7.3, "碳水": 5.5, "糖": 5.0, "鈉": 800},
    "精製細砂": {"熱量": 384, "蛋白質": 0.0, "脂肪": 0.0, "碳水": 100.0, "糖": 100.0, "鈉": 0},
    "麥芽糖漿HM85": {"熱量": 302, "蛋白質": 0.0, "脂肪": 0.0, "碳水": 75.0, "糖": 35.0, "鈉": 2},
    "自來水": {"熱量": 0, "蛋白質": 0.0, "脂肪": 0.0, "碳水": 0.0, "糖": 0.0, "鈉": 0},
    "統一麵粉": {"熱量": 357, "蛋白質": 9.8, "脂肪": 1.0, "碳水": 76.0, "糖": 0.3, "鈉": 4},
    "無鋁泡打粉": {"熱量": 156, "蛋白質": 0.0, "脂肪": 0.0, "碳水": 39.0, "糖": 0.0, "鈉": 7500},
    "穀物奶粉": {"熱量": 485, "蛋白質": 9.7, "脂肪": 7.0, "碳水": 79.0, "糖": 2.0, "鈉": 37},
    "赤藻糖醇": {"熱量": 0, "蛋白質": 0.0, "脂肪": 0.0, "碳水": 97.5, "糖": 0.0, "鈉": 0},
    "乳酪粉": {"熱量": 514, "蛋白質": 13.5, "脂肪": 13.6, "碳水": 20.7, "糖": 20.7, "鈉": 0},
    "三合力9285": {"熱量": 0, "蛋白質": 0.0, "脂肪": 0.0, "碳水": 0.0, "糖": 0.0, "鈉": 0},
    "帕瑪森起士粉": {"熱量": 420, "蛋白質": 35.0, "脂肪": 30.0, "碳水": 5.0, "糖": 0.0, "鈉": 1800},
    "沙拉油": {"熱量": 884, "蛋白質": 0.0, "脂肪": 100.0, "碳水": 0.0, "糖": 0.0, "鈉": 0},
}

def calc_nutrition(formula):
    total_water = 0
    water_ratio = {"冷藏未殺菌液蛋白": 0.88, "冷藏未殺菌液蛋黃": 0.50, "自來水": 1.00}
    for k, v in formula.items():
        if k in water_ratio:
            total_water += v * water_ratio[k]
    dry = 100 - total_water
    baked = dry / 0.97
    factor = 25 / baked
    result = {"熱量": 0, "蛋白質": 0, "脂肪": 0, "碳水": 0, "糖": 0, "鈉": 0, "赤藻糖醇": 0}
    for k, v in formula.items():
        ing = ingredient_db[k]
        for key in result:
            if key == "赤藻糖醇" and k == "赤藻糖醇":
                result[key] += 97.5 * v / 100 * factor
            elif key != "赤藻糖醇":
                result[key] += ing[key] * v / 100 * factor
    return {k: round(v, 2) for k, v in result.items()}


def ai_flavor_feedback(formula):
    msg = []
    if formula.get("冷藏未殺菌液蛋白", 0) + formula.get("冷藏未殺菌液蛋黃", 0) + formula.get("自來水", 0) > 45:
        msg.append("口感潤澤、蓬鬆感佳。")
    else:
        msg.append("可能偏乾或膨發不足，可考慮增加液蛋或水分。")
    if formula.get("乳酪粉", 0) + formula.get("帕瑪森起士粉", 0) + formula.get("三合力9285", 0) > 8:
        msg.append("起司風味濃郁，適合重口味起司點心。")
    elif formula.get("三合力9285", 0) < 0.15:
        msg.append("起司香氣偏弱，建議提升香料比例至 0.2%。")
    if formula.get("赤藻糖醇", 0) > 6:
        msg.append("甜感略帶冷涼感，建議適度混合砂糖調和。")
    elif formula.get("精製細砂", 0) < 12:
        msg.append("甜度可能略低，成品風味偏淡。")
    if formula.get("大豆蛋白", 0) + formula.get("乳清蛋白", 0) > 10:
        msg.append("蛋白質含量高，需注意是否影響膨發與口感密實度。")
    return "\n".join(msg)


def smart_substitution_advice(formula):
    suggestions = []

    if formula.get("精製細砂", 0) > 15:
        suggestions.append(
            "🔍 問題：精製細砂比例偏高（>15%）\n"
            "📌 原因：砂糖比例過高容易導致甜味壓過其他風味（如乳香、起司），且在烘焙時上色過快、升糖指數高，降低健康形象。\n"
            "✅ 建議：將比例降至約12%，可保留甜感並搭配赤藻糖醇補足，降低GI並保有甜味層次。"
        )

    if formula.get("赤藻糖醇", 0) > 6:
        suggestions.append(
            "🔍 問題：赤藻糖醇使用量偏高（>6%）\n"
            "📌 原因：過量可能導致冷涼感明顯、澀味增加，並可能在烘焙表面結晶產生顆粒感。\n"
            "✅ 建議：赤藻糖醇建議控制在6%以下，搭配砂糖可穩定甜感口感與烘焙穩定性。"
        )

    if formula.get("大豆蛋白", 0) + formula.get("乳清蛋白", 0) > 10:
        suggestions.append(
            "🔍 問題：蛋白粉總比例偏高（大豆+乳清 >10%）\n"
            "📌 原因：粉狀蛋白過多可能造成脆餅口感乾硬、密實、難以蓬發，影響脆度與適口性。\n"
            "✅ 建議：總粉體蛋白建議控制在8～10%以內，並搭配液蛋提升口感與結構穩定性。"
        )

    liquid_total = formula.get("冷藏未殺菌液蛋白", 0) + formula.get("冷藏未殺菌液蛋黃", 0) + formula.get("自來水", 0)
    if liquid_total < 35:
        suggestions.append(
            f"🔍 問題：液體總比例偏低（目前為 {liquid_total:.1f}%）\n"
            "📌 原因：液體不足會導致烘焙成品乾硬、難以蓬鬆，且易造成成品表面龜裂。\n"
            "✅ 建議：液體比例建議維持在40～50%，可透過增加液蛋或水來改善濕潤度與蓬鬆性。"
        )

    if formula.get("三合力9285", 0) < 0.2:
        suggestions.append(
            "🔍 問題：三合力香料比例偏低（<0.2%）\n"
            "📌 原因：香氣強度不足可能導致產品缺乏特色嗅覺記憶點，起司風味表現不明顯。\n"
            "✅ 建議：調升至0.2%為標準建議值，有助於提升產品辨識度與起司主題表現。"
        )

    if formula.get("沙拉油", 0) < 3:
        suggestions.append(
            "🔍 問題：沙拉油比例偏低（<3%）\n"
            "📌 原因：油脂不足可能造成口感過乾、脆化不完全、香氣層次不飽滿。\n"
            "✅ 建議：建議維持3～5%油脂比例作為酥脆潤口基礎，搭配乳酪粉可提升整體風味厚度。"
        )

    if not suggestions:
        return "✅ 目前配方整體結構穩定，營養比例平衡，無需大幅調整。"

    return "\n\n".join(suggestions)

